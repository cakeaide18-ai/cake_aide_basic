name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  analyze-and-test:
    name: Analyze & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Cache Pub packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-
      - name: Install Flutter SDK (manual)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y xz-utils curl git
          FLUTTER_VERSION=3.24.5
          curl -L "https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_${FLUTTER_VERSION}-stable.tar.xz" -o flutter.tar.xz
          sudo tar xf flutter.tar.xz -C /opt
          echo "/opt/flutter/bin" >> $GITHUB_PATH
          # Also export PATH in the current shell so subsequent commands in this step can use flutter
          export PATH="/opt/flutter/bin:$PATH"
      - name: Flutter doctor
        run: |
          echo "PATH is $PATH"
          /opt/flutter/bin/flutter --version
          /opt/flutter/bin/flutter doctor -v
      - name: Install dependencies
        run: /opt/flutter/bin/flutter pub get
      - name: Analyze
        run: /opt/flutter/bin/flutter analyze
      - name: Run tests
        run: /opt/flutter/bin/flutter test --coverage --reporter expanded
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/

  build-release:
    name: Build & Validate Release (main)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    env:
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - uses: actions/checkout@v4
      - name: Cache Pub packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-
      - name: Install Flutter SDK (manual)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y xz-utils curl git
          FLUTTER_VERSION=3.24.5
          curl -L "https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_${FLUTTER_VERSION}-stable.tar.xz" -o flutter.tar.xz
          sudo tar xf flutter.tar.xz -C /opt
          echo "/opt/flutter/bin" >> $GITHUB_PATH
          # Also export PATH in the current shell so subsequent commands in this step can use flutter
          export PATH="/opt/flutter/bin:$PATH"
      - name: Flutter doctor
        run: |
          echo "PATH is $PATH"
          /opt/flutter/bin/flutter --version
          /opt/flutter/bin/flutter doctor -v
      - name: Ensure required secrets are provided (Supabase only)
        run: |
          if [ -z "$SUPABASE_ANON_KEY" ]; then echo "SUPABASE_ANON_KEY secret is not set"; exit 1; fi
      - name: Install dependencies
        run: /opt/flutter/bin/flutter pub get
      - name: Analyze and Test
        run: |
          /opt/flutter/bin/flutter analyze
          /opt/flutter/bin/flutter test
      - name: Upload test results (if any)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: build/
